---
// Astro-Props für Nonce abrufen
const nonce = Astro.props.nonce;
---

<script async nonce={nonce}>
  // Funktion, um das GTM-Skript zu laden, wenn Zustimmung erteilt wurde
  function loadGTM() {
    var script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtm.js?id=GTM-PWK4LSL";
    document.head.appendChild(script);

    script.onload = function() {
      // Hier nach dem Laden des GTM-Skripts Google Analytics und Ads aktivieren
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }

      gtag("js", new Date());

      // Zustimmung für Analytics und Ads nach Einwilligung setzen
      gtag("consent", "update", {
        ad_storage: "granted",
        analytics_storage: "granted",
        ad_personalization: "granted",
        personalization_storage: "granted",
        ad_user_data: "granted"
      });

      // Konfigurationen von Google Analytics und Ads laden
      gtag("config", "GT-MR4MFC6");
      gtag("config", "GT-5TG3DK3");
    };
  }

  // Warten auf die Änderung der Einwilligung und dann GTM laden
  window.addEventListener("iubenda_consents_updated", function () {
    loadGTM();  // Lade GTM nach Einwilligung
  });

  // Standardmäßig keine Zustimmung setzen
  gtag("consent", "default", {
    ad_storage: "denied",
    analytics_storage: "denied",
    ad_personalization: "denied",
    personalization_storage: "denied",
    ad_user_data: "denied"
  });
</script>
