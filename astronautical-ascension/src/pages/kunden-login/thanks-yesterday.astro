---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getPageUrl } from "../../utils/getPageUrl.js";
import fs from "fs";
import path from "path";

const token = Astro.url.searchParams.get("token");
const filePath = path.resolve("data/tokens.json");

let tokens = [];
if (fs.existsSync(filePath)) {
  tokens = JSON.parse(fs.readFileSync(filePath, "utf-8"));
}

const now = new Date();
const valid = tokens.find(
  t => t.token === token && t.product === "yesterday" && new Date(t.expires) > now
);

const pageTitle = "Danke – Dein Download ist bereit";
const description =
  "Vielen Dank für deine Zahlung! Dein Noten- & Tabulaturblatt ‚Yesterday‘ ist jetzt zum Download verfügbar.";
const keywords = "Yesterday, Noten, Tabulatur, Download Noten, PDF";
const pageUrl = getPageUrl(Astro);
---

<BaseLayout
  pageTitle={pageTitle}
  description={description}
  keywords={keywords}
  href={pageUrl}
  ogTitle={pageTitle}
  ogDescription={description}
  ogUrl={pageUrl}
  ogType="website"
  twitterTitle={pageTitle}
  twitterDescription={description}
  twitterUrl={pageUrl}
>
  <h1>Danke für deine Zahlung!</h1>

  {valid ? (
    <>
      <h2>Download bereit</h2>

      <a href="/downloads/Yesterday.pdf" download class="cta-button">
        Yesterday – Noten & Tabulatur
      </a>

      <a href="/downloads/Yesterday-Strings.pdf" download class="cta-button">
        Yesterday – Strings
      </a>
    </>
  ) : (
    <p>❌ Download-Link ungültig oder abgelaufen.</p>
  )}

  <p>
    Falls es Probleme mit dem Download gibt, schreib mir bitte eine kurze
    E-Mail: <br />
    <strong>postmaster@musicstudio-ziebart.de</strong>
  </p>
</BaseLayout>