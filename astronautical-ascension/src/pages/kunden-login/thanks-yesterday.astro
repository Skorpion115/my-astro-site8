---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getPageUrl } from "../../utils/getPageUrl.js";
import { getStore } from "@netlify/blobs";

/* --------------------------------------------------
   Token aus URL lesen
-------------------------------------------------- */
const token = Astro.url.searchParams.get("token");

/* --------------------------------------------------
   Netlify Blob Store Ã¶ffnen
-------------------------------------------------- */
const store = getStore("download-tokens");

/* --------------------------------------------------
   Token prÃ¼fen
   Hinweis: store.get liefert ArrayBuffer â†’ in String umwandeln
-------------------------------------------------- */
let valid = false;

if (token) {
  const entry = await store.get(token);

  if (entry) {
    // ArrayBuffer â†’ UTF-8 String
    const text = new TextDecoder().decode(entry);
    const data = JSON.parse(text);

    valid =
      data.product === "yesterday" &&
      new Date(data.expires) > new Date();
  }
}

/* --------------------------------------------------
   SEO / Meta
-------------------------------------------------- */
const pageTitle = "Danke â€“ Dein Download ist bereit";
const description =
  "Vielen Dank fÃ¼r deine Zahlung! Dein Noten- & Tabulaturblatt â€šYesterdayâ€˜ ist jetzt zum Download verfÃ¼gbar.";
const keywords = "Yesterday, Noten, Tabulatur, Download Noten, PDF";
const pageUrl = getPageUrl(Astro);
---

<BaseLayout
  pageTitle={pageTitle}
  description={description}
  keywords={keywords}
  href={pageUrl}
  ogTitle={pageTitle}
  ogDescription={description}
  ogUrl={pageUrl}
  ogType="website"
  twitterTitle={pageTitle}
  twitterDescription={description}
  twitterUrl={pageUrl}
>
  <h1>Danke fÃ¼r deine Zahlung!</h1>

  {valid ? (
    <>
      <h2>Dein Download ist bereit</h2>

      <p>
        <a href="/downloads/Yesterday.pdf" download class="cta-button">
          Yesterday â€“ Noten &amp; Tabulatur
        </a>
      </p>

      <p>
        <a href="/downloads/Yesterday-Strings.pdf" download class="cta-button">
          Yesterday â€“ Strings / Streicherstimmen
        </a>
      </p>

      <p>
        Viel Freude beim Spielen! ğŸµ
      </p>
    </>
  ) : (
    <>
      <h2>Download nicht verfÃ¼gbar</h2>
      <p>
        âŒ Dieser Download-Link ist ungÃ¼ltig oder abgelaufen.
      </p>
    </>
  )}

  <p>
    Falls es Probleme mit dem Download gibt, schreib mir bitte eine kurze
    E-Mail:<br />
    <strong>postmaster@musicstudio-ziebart.de</strong>
  </p>
</BaseLayout>
